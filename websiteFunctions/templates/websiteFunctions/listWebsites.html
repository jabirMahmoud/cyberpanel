{% extends "baseTemplate/index.html" %}
{% load i18n %}
{% block title %}{% trans "Websites Hosted - CyberPanel" %}{% endblock %}
{% block content %}

    {% load static %}
    {% get_current_language as LANGUAGE_CODE %}
    <!-- Current language: {{ LANGUAGE_CODE }} -->

    <!-- Add Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script>
        $(document).ready(function () {
            $('[data-toggle="tooltip"]').tooltip();
        });
    </script>

    <div ng-controller="listWebsites" class="container">
        <!-- Loading State -->
        <div ng-show="loading" class="text-center" style="padding: 50px;">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="sr-only">Loading...</span>
            </div>
            <h4 class="mt-3">{% trans "Loading websites..." %}</h4>
        </div>

        <!-- Main Content (hidden while loading) -->
        <div ng-hide="loading">
            <!-- Password Protection Modal -->
            <div class="modal fade" id="passwordProtectionModal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Password Protection</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="form-group">
                                    <label>Username</label>
                                    <input type="text" class="form-control" ng-model="currentWP.PPUsername" required>
                                </div>
                                <div class="form-group">
                                    <label>Password</label>
                                    <input type="password" class="form-control" ng-model="currentWP.PPPassword" required>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" ng-click="submitPasswordProtection()">Enable Protection</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-title">
                <h2 id="domainNamePage">{% trans "List Websites" %}
                    <a class="pull-right btn btn-primary" href="{% url "createWebsite" %}">{% trans "Create Website" %}</a>
                </h2>
                <img ng-hide="cyberPanelLoading" src="{% static 'images/loading.gif' %}">
                <p>{% trans "On this page you can launch, list, modify and delete websites from your server." %}</p>
            </div>

            <div class="row" style="margin-bottom: 18px;">
                <div class="col-sm-10">
                    <input ng-keypress="$event.keyCode === 13 && searchWebsites()" placeholder="Search... (Press Enter to search)" ng-model="patternAdded" name="dom" type="text" class="form-control" required>
            </div>
            <div class="col-sm-2">
                    <select ng-model="recordsToShow" ng-change="getFurtherWebsitesFromDB()" class="form-control" id="example-select">
                        <option>10</option>
                        <option>50</option>
                        <option>100</option>
                    </select>
                </div>
            </div>

            <!-- Websites List with New Collapsed Design -->
            <div ng-repeat="web in WebSitesList track by $index" class="website-card">
                <div class="website-header" ng-click="toggleSite(web)" title="Expand/collapse details">
                    <div class="header-left">
                        <i class="fas chevron" ng-class="{'fa-chevron-down': isExpanded(web.domain), 'fa-chevron-right': !isExpanded(web.domain)}"></i>
                        <span class="domain" title="{$ web.domain $}">{$ web.domain $}</span>
                        <span ng-if="web.loading" class="loading-indicator"><i class="fa fa-spinner fa-spin"></i></span>
                            </div>
                    <div class="header-actions">
                        <button class="btn btn-primary btn-sm" title="{% trans 'Manage' %}" ng-click="goToManage($event, web.domain)">Manage</button>
                        <button class="btn btn-outline-secondary btn-sm" title="{% trans 'File Manager' %}" ng-click="goToFileManager($event, web.domain)">Filemanager</button>
                            </div>
                        </div>
                <div class="website-content" ng-if="isExpanded(web.domain)">
                    <div class="row">
                        <div class="col-md-3 col-sm-12">
                            <img ng-src="https://api.microlink.io/?url=https://{$ web.domain $}&screenshot=true&meta=false&embed=screenshot.url" alt="{$ web.domain $}" class="img-responsive website-screenshot" onerror="this.onerror=null; this.src='{% static 'baseTemplate/assets/image-resources/webPanel.png' %}';">
                            <div class="text-center website-action-buttons">
                                <a href="http://{$ web.domain $}" target="_blank" class="btn btn-outline-secondary btn-sm" title="{% trans 'Visit Site' %}">{% trans 'Visit Site' %}</a>
                                <a ng-click="issueSSL(web.domain)" href="javascript:void(0);" class="btn btn-outline-primary btn-sm" title="{% trans 'Issue SSL' %}">{% trans 'Issue SSL' %}</a>
                                <button ng-click="showWPSites(web.domain); $event.stopPropagation();" class="btn btn-outline-info btn-sm wp-toggle-btn" title="Show/Hide WordPress Sites">
                                    {$ (web.wp_sites && web.wp_sites.length) || 0 $} WP Site<span ng-if="(web.wp_sites && web.wp_sites.length) != 1">s</span>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-9 col-sm-12">
                            <div class="row info-row">
                                <div class="col-md-4 col-sm-6 info-box"><label>{% trans 'State' %}</label><span>{$ web.state $}</span></div>
                                <div class="col-md-4 col-sm-6 info-box"><label>{% trans 'IP Address' %}</label><span>{$ web.ipAddress $}</span></div>
                                <div class="col-md-4 col-sm-6 info-box"><label>{% trans 'PHP Version' %}</label><span>{$ web.phpVersion $}</span></div>
                            </div>
                            <div class="row info-row">
                                <div class="col-md-4 col-sm-6 info-box"><label>{% trans 'Disk Usage' %}</label><span>{$ web.diskUsed $}</span></div>
                                <div class="col-md-4 col-sm-6 info-box"><label>{% trans 'Package' %}</label><span>{$ web.package $}</span></div>
                                <div class="col-md-4 col-sm-6 info-box"><label>{% trans 'Owner' %}</label><span>{$ web.admin $}</span></div>
                            </div>
                        </div>
                    </div>
                    <!-- WordPress Sites section moved OUTSIDE the row for full width -->
                    <div class="wp-sites-section" ng-if="web.showWPSites && web.wp_sites && web.wp_sites.length > 0" style="width: 100%;">
                        <h5 class="wp-sites-title"><i class="fa-brands fa-wordpress"></i> {% trans 'WordPress Sites' %} <span class="badge badge-info">{$ web.wp_sites.length $}</span></h5>
                        <div ng-repeat="wp in web.wp_sites" class="wp-site-item">
                            <div class="row">
                                <div class="col-md-3 col-sm-12">
                                    <img ng-src="{$ wp.screenshot $}" alt="{$ wp.title $}" class="img-responsive wp-screenshot" onerror="this.onerror=null; this.src='https://s.wordpress.org/style/images/about/WordPress-logotype-standard.png'">
                                    <div class="text-center wp-action-buttons">
                                        <a href="javascript:void(0);" ng-click="visitSite(wp)" class="btn btn-outline-secondary btn-sm wp-action-btn" title="{% trans 'Visit Site' %}"><i class="fa-solid fa-external-link"></i> {% trans 'Visit Site' %}</a>
                                        <a href="{% url 'AutoLogin' %}?id={$ wp.id $}" target="_blank" class="btn btn-outline-primary btn-sm wp-action-btn" title="{% trans 'WP Login' %}"><i class="fa-brands fa-wordpress"></i> {% trans 'WP Login' %}</a>
                                    </div>
                                </div>
                                <div class="col-md-9 col-sm-12">
                                    <div class="row">
                                        <div class="col-md-3 col-sm-6 info-box"><label>WordPress</label><span>{$ wp.version || 'Loading...' $}</span></div>
                                        <div class="col-md-3 col-sm-6 info-box"><label>PHP Version</label><span>{$ wp.phpVersion || 'Loading...' $}</span></div>
                                        <div class="col-md-3 col-sm-6 info-box"><label>Theme</label><span>{$ wp.theme || 'Loading...' $}</span></div>
                                        <div class="col-md-3 col-sm-6 info-box"><label>Plugins</label><span>{$ wp.activePlugins || '0' $} active</span></div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-sm-6">
                                            <div class="checkbox"><label><input type="checkbox" ng-click="updateSetting(wp, 'search-indexing')" ng-checked="wp.searchIndex == 1"> {% trans 'Search engine indexing' %}</label></div>
                                            <div class="checkbox"><label><input type="checkbox" ng-click="updateSetting(wp, 'debugging')" ng-checked="wp.debugging == 1"> {% trans 'Debugging' %}</label></div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="checkbox"><label><input type="checkbox" ng-model="wp.passwordProtection" ng-init="wp.passwordProtection = wp.passwordProtection || false" ng-change="togglePasswordProtection(wp)"> {% trans 'Password protection' %}</label></div>
                                            <div class="checkbox"><label><input type="checkbox" ng-click="updateSetting(wp, 'maintenance-mode')" ng-checked="wp.maintenanceMode == 1"> {% trans 'Maintenance mode' %}</label></div>
                                        </div>
                                    </div>
                                    <div class="wp-site-actions text-right">
                                        <button class="btn btn-outline-primary btn-sm wp-action-btn" ng-click="manageWP(wp.id)"><i class="fa-solid fa-cog"></i> {% trans 'Manage' %}</button>
                                        <button class="btn btn-outline-danger btn-sm wp-action-btn" ng-click="deleteWPSite(wp)"><i class="fa-solid fa-trash"></i> {% trans 'Delete' %}</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Display -->
            <div id="listFail" class="alert alert-danger" style="display: none;">
                <p>{% trans "Cannot list websites. Error message:" %} {$ errorMessage $}</p>
            </div>

            <!-- Pagination -->
            <div style="margin-top: 2%" class="row">
                <div class="col-md-12">
                    <div class="row">
                        <div class="col-md-9"></div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <select ng-model="currentPage" class="form-control" ng-change="getFurtherWebsitesFromDB()">
                                    <option ng-repeat="page in pagination">{$ $index + 1 $}</option>
                                </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

    <!-- Enhanced Styles -->
                        <style>
        .website-card {
            margin-bottom: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07);
            background: #fff;
            transition: box-shadow 0.2s;
        }
        .website-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 24px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }
        .website-header:hover {
            background: #f8fafc;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
        }
        .chevron {
            font-size: 1.4em;
            color: #b0b4b9;
            min-width: 24px;
        }
        .domain {
            font-weight: 600;
            font-size: 1.1em;
            max-width: 220px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .header-actions .btn {
            margin-left: 8px;
        }
        .website-content {
            padding: 24px;
            background: #fcfcfd;
            border-radius: 0 0 12px 12px;
            animation: fadeIn 0.2s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-8px);}
            to { opacity: 1; transform: translateY(0);}
        }
        .website-screenshot {
                                border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                                border-radius: 8px;
            width: 100%;
            margin-bottom: 18px;
            min-height: 120px;
            background: #f5f5f5;
                            }
        .website-action-buttons {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            justify-content: center;
                            }
        .info-row {
            margin-bottom: 18px;
            gap: 0 18px;
        }
        .info-box {
            background: #f8fafc;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
            padding: 22px 18px 16px 18px;
            margin-bottom: 0;
            margin-top: 0;
            border: none;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .info-box label {
            font-size: 13px;
            color: #7b8794;
            font-weight: 600;
            letter-spacing: 1px;
            margin-bottom: 6px;
            text-transform: uppercase;
        }
        .info-box span {
            font-size: 1.18em;
            color: #23272f;
            font-weight: 700;
            letter-spacing: 0.2px;
        }
        .wp-sites-box {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #eaf6ff;
            border-left: 3px solid #007cba;
        }
        .badge-info {
            background: #007cba;
            color: #fff;
            font-size: 13px;
            padding: 4px 10px;
            border-radius: 12px;
            margin-left: 6px;
        }
        .wp-toggle-btn {
            margin-left: 12px;
            font-size: 13px;
            padding: 2px 12px;
        }
        .wp-sites-section {
            margin-top: 18px;
            background: #f6fafd;
            border-radius: 8px;
            padding: 18px 12px 8px 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.03);
        }
        .wp-sites-title {
            color: #00749C;
            font-size: 1.1em;
                                font-weight: 600;
            margin-bottom: 18px;
                            }
        .wp-site-item {
            border: 1px solid #e0e0e0;
            margin-bottom: 15px;
            border-radius: 6px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            padding: 12px 8px 8px 8px;
        }
        .wp-screenshot {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            width: 100%;
                                margin-bottom: 10px;
            min-height: 80px;
            background: #f5f5f5;
                            }
        .wp-action-buttons {
            margin-top: 8px;
            display: flex;
            gap: 8px;
            justify-content: center;
        }
                            .wp-action-btn {
                                margin: 0 4px;
                                padding: 6px 12px;
                                font-size: 13px;
                                font-weight: 500;
                                border-width: 1.5px;
                                line-height: 1.5;
                                display: inline-flex;
                                align-items: center;
                                justify-content: center;
                                vertical-align: middle;
                                height: 32px;
                            }
                            .wp-action-btn i {
                                margin-right: 6px;
                                font-size: 14px;
                                display: inline-flex;
                                align-items: center;
                            }
        .wp-site-actions {
            margin-top: 10px;
        }
        .checkbox {
            margin-bottom: 10px;
        }
        .mt-3 {
            margin-top: 1rem;
        }
        .loading-indicator {
            display: inline-flex;
            align-items: center;
                                gap: 8px;
            color: #00749C;
            font-size: 14px;
            padding: 0 8px;
                            }
        .loading-indicator i {
            font-size: 14px;
            margin-left: 4px;
                            }
                            .btn-outline-primary {
                                color: #0073aa;
                                border-color: #0073aa;
                            }
                            .btn-outline-primary:hover {
                                background-color: #0073aa;
                                color: white;
                            }
                            .btn-outline-secondary {
                                color: #50575e;
                                border-color: #50575e;
                            }
                            .btn-outline-secondary:hover {
                                background-color: #50575e;
                                color: white;
                            }
                            .btn-outline-danger {
                                color: #dc3545;
                                border-color: #dc3545;
                            }
                            .btn-outline-danger:hover {
                                background-color: #dc3545;
                                color: white;
                            }
        .btn-outline-info {
            color: #17a2b8;
            border-color: #17a2b8;
        }
        .btn-outline-info:hover {
            background-color: #17a2b8;
            color: white;
        }
        @media (max-width: 991px) {
            .website-header, .website-content { padding: 12px; }
            .info-row { gap: 0 8px; }
            .info-box { padding: 16px 10px; min-height: 60px; }
        }
        @media (max-width: 768px) {
            .website-header { flex-direction: column; align-items: flex-start; }
            .header-actions { margin-top: 10px; }
            .domain { max-width: 100%; }
            .website-content { padding: 12px; }
            .info-row { flex-direction: column; gap: 12px 0; }
            .info-box { width: 100%; }
        }
    </style>

{% endblock %}
